## 签名校验

1. 使用 [wx.login](/API/开放接口/登录/README.md#wxloginobject) 获取 code

2. 通过 code 换取用户的 session-key 和 openid

3. 需要页面自己去做登录态管理（如在 cookie 设置 openid ）

4. 通过调用接口（如 [wx.getUserInfo](/API/开放接口/用户信息.md)）获取敏感数据时，接口会同时返回 rawData、signature，其中 signature = sha1\( rawData + session\_key \)

5. 将 signature、rawData、以及用户登录态发送给开发者服务器，开发者在数据库中找到该用户对应的 session-key，使用相同的算法计算出签名 signature2 ，比对 signature 与 signature2 即可校验数据的可信度。

**如wx.getUserInfo的数据校验：**

接口返回的rawData：

```
{
  "nickName": "Band",
  "gender": 1,
  "language": "zh_CN",
  "city": "Guangzhou",
  "province": "Guangdong",
  "country": "CN",
  "avatarUrl": "http://wx.qlogo.cn/mmopen/vi_32/1vZvI39NWFQ9XM4LtQpFrQJ1xlgZxx3w7bQxKARol6503Iuswjjn6nIGBiaycAjAtpujxyzYsrztuuICqIM5ibXQ/0"
}
```

用户的 session-key：

```
HyVFkGl5F5OQWJZZaNzBBg==
```

所以，用于签名的字符串为：

```
{
  "nickName": "Band",
  "gender": 1,
  "language": "zh_CN",
  "city": "Guangzhou",
  "province": "Guangdong",
  "country": "CN",
  "avatarUrl": "http://wx.qlogo.cn/mmopen/vi_32/1vZvI39NWFQ9XM4LtQpFrQJ1xlgZxx3w7bQxKARol6503Iuswjjn6nIGBiaycAjAtpujxyzYsrztuuICqIM5ibXQ/0"}HyVFkGl5F5OQWJZZaNzBBg=="
}
```

使用sha1得到的结果为

```
75e81ceda165f4ffa64f4068af58c64b8f54b88c
```

## 加密数据解密算法

接口如果涉及敏感数据（如[`wx.getUserInfo`](/API/开放接口/用户信息.md)当中的 openid ），接口的明文内容将不包含敏感数据。开发者如需要获取敏感数据，需要对接口返回的**加密数据\( encryptData \)**进行对称解密。 解密算法如下：

1. 对称解密使用的算法为 AES-128-CBC，数据采用PKCS\#7填充。

2. 对称解密的目标密文为 Base64\_Decode\(encryptData\),

3. 对称解密秘钥 aeskey = Base64\_Decode\(session\_key\), aeskey 是16字节

4. 对称解密算法初始向量 iv = aeskey, 同样是16字节

